/*!
 * Previolet Javascript SDK v1.0.0
 * https://github.com/previolet/previolet-js-sdk
 * Released under the MIT License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PrevioletSDK=e()}(this,function(){"use strict";function t(t,e){e=e||t.instance;var o=t.baseUrl.replace("{{instance}}",e);return o=o.replace("{{region}}",t.region)}function e(t){switch(t.storageType){case"localStorage":try{return n.localStorage.setItem("testKey","test"),n.localStorage.removeItem("testKey"),new i(t.storageNamespace)}catch(t){}default:return new i(t.storageNamespace)}}var o={baseUrl:"https://{{instance}}.{{region}}.previolet.com/v1",region:"eu.east1",guestTokenExpiration:5,storageType:"localStorage",storageNamespace:"previolet-sdk",tokenName:"token",applicationStorage:"app",browserIdentification:"bid",userStorage:"user",debug:!1,reqIndex:1,sdkVersion:"1.0.0",appVersion:"-",defaultConfig:{}},r={atob:function(){},open:function(){},location:{},localStorage:{setItem:function(){},getItem:function(){},removeItem:function(){}},sessionStorage:{setItem:function(){},getItem:function(){},removeItem:function(){}}},n=void 0!==typeof window?window:r,i=function(t){this.namespace=t||null};i.prototype.setItem=function(t,e){n.localStorage.setItem(this._getStorageKey(t),e)},i.prototype.getItem=function(t){return n.localStorage.getItem(this._getStorageKey(t))},i.prototype.removeItem=function(t){n.localStorage.removeItem(this._getStorageKey(t))},i.prototype._getStorageKey=function(t){return this.namespace?[this.namespace,t].join("."):t};var s=function(t,e,o,r){this.options=t,this.token=e,this.bi=JSON.stringify(o),this.errorProxy=r};s.prototype.__generateRandomNumber=function(t,e){return t=t||100,e=e||999,Math.floor(Math.random()*e+t)},s.prototype.__checkError=function(t){if(t.error)throw this.options.debug&&console.log("%cBackend error details","color: #FF3333",t),"function"==typeof this.errorProxy&&this.errorProxy(t),t.error},s.prototype.__call=function(e,o){var r=this;o.headers=Object.assign({},{Authorization:this.token,Identification:btoa(this.bi)});var n=t(this.options)+e,i=this.options.reqIndex++;return this.options.debug&&console.log("‚¨ÜÔ∏è XHR Request ("+i+"): ",n,o),axios(n,o).then(function(t){return r.options.debug&&console.log("‚¨áÔ∏è XHR Response ("+i+")",t),t.data}).catch(function(t){throw t})};var a=function(t){function e(e,o,r,n){t.call(this,e,o,r,n),this.currentDatabase=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getAll=function(){var t=this,e={method:"GET"};return this.__call("/__/index",e).then(function(e){return t.__checkError(e),e.result.objects})},e.prototype.select=function(t){return this.currentDatabase=t,this},e.prototype.add=function(t){var e=this;t=t||{};var o={method:"POST",data:t};return this.__callDatabase(o).then(function(t){return e.__checkError(t),t.result?t.result:t})},e.prototype.get=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o).then(function(t){return e.__checkError(t),t.result?t.result:[]})},e.prototype.getOne=function(t){var e=this;t=t||{},t._limit=1;var o={method:"GET",params:t};return this.__callDatabase(o).then(function(t){return e.__checkError(t),!(!t.result||!t.result[0])&&t.result[0]})},e.prototype.getCount=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/count").then(function(t){return e.__checkError(t),t.result?parseInt(t.result):0})},e.prototype.update=function(t,e){var o=this;e=e||{};var r={method:"PUT",data:e};return this.__callDatabase(r,"/"+t).then(function(t){return o.__checkError(t),t.result?t.result:t})},e.prototype.delete=function(t){var e=this,o={method:"DELETE"};return this.__callDatabase(o,"/"+t).then(function(t){return e.__checkError(t),t.result?t.result:t})},e.prototype.fieldExists=function(t){},e.prototype.addField=function(t){},e.prototype.getViews=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/structure/views").then(function(t){return e.__checkError(t),t.result?t.result:[]})},e.prototype.getDistinct=function(t,e){},e.prototype.getDistinctCount=function(t,e){},e.prototype.__callDatabase=function(t,e){return e=e||"",null===this.currentDatabase?Promise.reject(new Error("Please select a database")):this.__call("/"+this.currentDatabase+e,t)},e}(s),u=function(t){function e(e,o,r,n){t.call(this,e,o,r,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getAll=function(){var t={method:"GET"};return this.__call("/__/function",t).then(function(t){return t.result})},e.prototype.run=function(t,e){e=e||!1;var o={method:"POST",data:e};return this.__call("/__/function/"+t,o).then(function(t){return t.result?t.result:t})},e}(s),c=function(t){function e(e,o,r,n){t.call(this,e,o,r,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getAll=function(){var t={method:"GET"};return this.__call("/__/storage",t).then(function(t){return t.result})},e}(s),l=function(t){function e(e,o,r,n){t.call(this,e,o,r,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){var t=this,e={method:"GET"};return this.__call("/__/remote-config",e).then(function(e){if("object"==typeof e){var o=t.options.defaultConfig;return Object.keys(e).forEach(function(t){o[t]=e[t]}),o}return t.options.defaultConfig})},e.prototype.defaultConfig=function(t){this.options.defaultConfig=t},e}(s),p=function(t){var r=this,n=Object.assign({},o,t),i=!1,s=null,p=null,h={};this.changeHooks=[],this.storageApi=e(n),this.auth={GithubAuthProvider:{id:"github"},GoogleAuthProvider:{id:"google"},FacebookAuthProvider:{id:"facebook"}},Object.defineProperties(this,{options:{get:function(){return n}},token:{get:function(){return i},set:function(t){t!=i&&(i=t,r.storageApi.setItem(n.tokenName,i))}},headers:{get:function(){return h}},currentApp:{get:function(){return s},set:function(t){s=t,r.storageApi.setItem(n.applicationStorage,btoa(JSON.stringify(t)))}},currentUser:{get:function(){return p},set:function(t){p=t,r.storageApi.setItem(n.userStorage,btoa(JSON.stringify(t)))}},browserIdentification:{get:function(){return r.__storageGet(r.options.browserIdentification)},set:function(t){t.ts=Date.now(),t.rnd=r.__generateRandomNumber(1e4,99999),r.storageApi.setItem(n.browserIdentification,btoa(JSON.stringify(t)))}}}),r.app=function(){return{region:r.options.region,token:r.storageApi.getItem(r.options.tokenName)||!1,data:r.__storageGet(r.options.applicationStorage)}};var g=r.app().token;r.token=g,r.browserIdentification||(r.browserIdentification={ua:navigator.userAgent,lang:navigator.language||navigator.userLanguage,plat:navigator.platform,vsdk:r.options.sdkVersion,vapp:r.options.appVersion}),r.options.debug&&(console.log("%cüöÄ Previolet Javascript SDK instantiated in debug mode","color: #CC00FF"),console.log("Browser identification",r.browserIdentification)),r.errorProxy=function(t){t&&t.error_code&&3==t.error_code&&r.logout()},r.db=function(){return new a(n,i,r.browserIdentification,r.errorProxy)},r.functions=function(){return new u(n,i,r.browserIdentification,r.errorProxy)},r.storage=function(){return new c(n,i,r.browserIdentification,r.errorProxy)},r.remoteConfig=function(){return new l(n,i,r.browserIdentification,r.errorProxy)},r.user=function(){return{data:r.__storageGet(r.options.userStorage)}},r.currentUser=r.user().data};return p.prototype.isAuthenticated=function(){return!!this.token},p.prototype.onAuthStateChanged=function(t){if("function"==typeof t){-1==this.changeHooks.indexOf(t)?(this.options.debug&&console.log("Registered callback function: onAuthStateChanged",t),this.changeHooks.push(t)):this.options.debug&&console.log("Callback function onAuthStateChanged is already registered",t);var e=this.currentUser;return this.options.debug&&(e?console.log("User is logged in",e):console.log("User is not logged in")),t(e)}return this.options.debug&&console.log("User is not logged in"),!1},p.prototype.logout=function(){var t=this;if(!this.isAuthenticated())return Promise.reject(new Error("There is no authenticated user"));var e=JSON.stringify({token:this.token}),o={method:"DELETE",data:e};return this.options.debug&&console.log("Logging Out"),this.__call("/__/token",o,"token").then(function(e){return t.storageApi.removeItem(t.options.tokenName),t.storageApi.removeItem(t.options.applicationStorage),t.storageApi.removeItem(t.options.userStorage),t.changeHooks.forEach(function(t){t(!1)}),t.__checkError(e),e})},p.prototype.getDefaultHeaders=function(){return Object.assign({},this.headers,{})},p.prototype.requestGuestToken=function(){var t=this,e=JSON.stringify({expire:this.options.guestTokenExpiration}),o={method:"POST",data:e};return this.__call("/__/auth/guest",o).then(function(e){t.__checkError(e),e.result.token&&(t.token=e.result.token)})},p.prototype.loginWithUsernameAndPassword=function(t,e){var o=this;if(!t)return Promise.reject(new Error("username required"));if(!e)return Promise.reject(new Error("password required"));this.options.debug&&console.log("Logging In with username and password",t,e);var r=JSON.stringify({name:t,challenge:e}),n={method:"POST",data:r};return this.__call("/__/auth",n).then(function(t){return o.__checkError(t),o.__loadAuthenticationDataFromResponse(t),o.currentUser&&o.changeHooks.forEach(function(t){o.options.debug&&console.log("Triggering onAuthStateChanged callback",o.currentUser),t(o.currentUser)}),t.result.data})},p.prototype.loginWithIdentityProvider=function(t,e){var o=this;e=e||this.last_access_token,this.last_access_token=e,this.options.debug&&console.log("Logging In with identity provider:",t,e);var r={access_token:e},n={method:"POST",params:r};return this.__call("/__/auth/identity/"+t,n).then(function(t){return o.__checkError(t),t.result?t.result&&(t.result.token&&t.result.auth?(o.__loadAuthenticationDataFromResponse(t),o.changeHooks.forEach(function(e){o.options.debug&&console.log("Triggering onAuthStateChanged callback",t.result.auth),e(t.result.auth)})):o.changeHooks.forEach(function(t){o.options.debug&&console.log("Triggering onAuthStateChanged callback",!1),t(!1)})):o.changeHooks.forEach(function(t){t(!1)}),t.result})},p.prototype.registerWithIdentityProvider=function(t,e,o,r){var n=this;o=o||this.last_access_token,r=r||!0,this.last_access_token=o;var i={access_token:o,email:e,role:"admin"},s={method:"POST",data:i};return this.__call("/__/auth/identity/"+t+"/register?_debug=3",s).then(function(e){return n.__checkError(e),r?n.loginWithIdentityProvider(t,o):e})},p.prototype.getRemoteConfig=function(){var t=this;return this.functions().getRemoteConfig().then(function(e){if("object"==typeof e){var o=t.options.defaultConfig;return Object.keys(e).forEach(function(t){o[t]=e[t]}),o}return t.options.defaultConfig})},p.prototype.__loadAuthenticationDataFromResponse=function(t){t.result.token&&t.result.auth&&(this.options.debug&&console.log("Saving token",t.result.token),this.token=t.result.token),t.result.auth&&(this.options.debug&&console.log("Saving user details",t.result.auth),this.currentUser=t.result.auth),t.result.data&&(t.result.data[this.options.instance]&&t.result.data[this.options.instance].instance_data?(this.currentApp=t.result.data[this.options.instance].instance_data,this.options.debug&&console.log("Saving application details",this.currentApp)):this.options.debug&&console.log("Application details not available"))},p.prototype.__call=function(e,o,r){var n=this;r=r||this.options.instance,o.headers=this.getDefaultHeaders();var i=this.options.reqIndex++,s=t(this.options,r)+e;return this.options.debug&&console.log("‚¨ÜÔ∏è XHR Request ("+i+")",s,o),axios(s,o).then(function(t){return n.options.debug&&console.log("‚¨áÔ∏è XHR Response ("+i+")",t),t.data}).catch(function(t){throw t})},p.prototype.__checkError=function(t){if(t.error)throw this.options.debug&&console.log("%cBackend error details","color: #FF3333",t),t.error},p.prototype.__storageGet=function(t){var e=this,o=e.storageApi.getItem(t),r=!1;if(o)try{r=JSON.parse(atob(o))}catch(t){}return r},p.prototype.__generateRandomNumber=function(t,e){return t=t||100,e=e||999,Math.floor(Math.random()*e+t)},p});