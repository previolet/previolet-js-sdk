/*!
 * Previolet Javascript SDK v1.0.6
 * https://github.com/previolet/previolet-js-sdk
 * Released under the MIT License.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PrevioletSDK=e()}(this,function(){"use strict";function t(t,e){e=e||t.instance;var o=t.baseUrl.replace("{{instance}}",e);return o=o.replace("{{region}}",t.region)}function e(t,e){return t=t||100,e=e||999,Math.floor(Math.random()*e+t)}function o(t){switch(t.storageType){case"localStorage":try{return a.localStorage.setItem("testKey","test"),a.localStorage.removeItem("testKey"),new s(t.storageNamespace)}catch(t){}default:return new s(t.storageNamespace)}}var n={baseUrl:"https://{{instance}}.{{region}}.previolet.com/v1",region:"eu.west1",guestTokenExpiration:3600,userTokenExpiration:864e3,storageType:"localStorage",storageNamespace:"previolet-sdk",tokenName:"token",applicationStorage:"app",browserIdentification:"bid",userStorage:"user",debug:!1,reqIndex:1,sdkVersion:"1.0.6",appVersion:"-",defaultConfig:{},tokenOverride:!1,tokenFallback:!1},r={NO_TOKEN:1,INVALID_TOKEN:2,TOKEN_DOESNT_MATCH_INSTANCE:3,NO_AUTH_SUPPORT:330,NO_AUTH_NAME_OR_CHALLENGE:331,INVALID_NAME_OR_CHALLENGE:332,NO_RULES_FOR_ROLE:333,CANNOT_REFRESH_TOKEN:334,INVALID_RESET_HASH:801,CHALLENGES_DO_NOT_MATCH:802,INVALID_CHALLENGE:803,NO_IDENTITY_PROVIDER_TOKEN:901,IDENTITY_ALREADY_REGISTERED:902,IDENTITY_ID_NOT_FOUND:903,IDENTITY_NOT_FOUND:904,IDENTITY_EMAIL_CONFLICT:905,IDENTITY_MISSING_GROUP:906},i={atob:function(){},open:function(){},location:{},localStorage:{setItem:function(){},getItem:function(){},removeItem:function(){}},sessionStorage:{setItem:function(){},getItem:function(){},removeItem:function(){}}},a=void 0!==typeof window?window:i,s=function(t){this.namespace=t||null};s.prototype.setItem=function(t,e){a.localStorage.setItem(this._getStorageKey(t),e)},s.prototype.getItem=function(t){return a.localStorage.getItem(this._getStorageKey(t))},s.prototype.removeItem=function(t){a.localStorage.removeItem(this._getStorageKey(t))},s.prototype._getStorageKey=function(t){return this.namespace?[this.namespace,t].join("."):t};var c=function(t){this.sdk=t,this.errorChain=[]};c.prototype.addToErrorChain=function(t,e){return"function"==typeof e?(this.errorChain.push({context:t,func:e}),this.sdk.options.debug&&console.log("Added function to error chain",t,e)):this.sdk.options.debug&&console.log("Cannot add function to error chain, not a function",t,e),this},c.prototype.__getTokenToUse=function(){var t=null;return this.sdk.token&&(this.sdk.options.debug&&console.log("Using stored token",this.sdk.token),t=this.sdk.token),!t&&this.sdk.options.tokenFallback&&(this.sdk.options.debug&&console.log("Token is now the fallback option",this.sdk.options.tokenFallback),t=this.sdk.options.tokenFallback),this.sdk.options.tokenOverride&&(this.sdk.options.debug&&console.log("Token is now the override option",this.sdk.options.tokenOverride),t=this.sdk.options.tokenOverride),t},c.prototype.__call=function(e,o){var n=this,r=this.__getTokenToUse(),i=this.sdk.browserIdentification;this.sdk.options.debug&&console.log("Using Identification",i),o.headers=Object.assign({},{Authorization:r,Identification:btoa(JSON.stringify(i))});var a=t(this.sdk.options)+e,s=this.sdk.options.reqIndex++;return this.sdk.options.debug&&console.log("> XHR Request ("+s+", "+r+"): ",a,o),axios(a,o).then(function(t){return n.sdk.options.debug&&console.log("< XHR Response ("+s+")",t),t.data}).catch(function(t){throw t})},c.prototype.__checkError=function(t,e){var o=this;if(e.error){if(!this.errorChain.length)throw this.sdk.options.debug&&console.log("%cBackend error details","color: #FF3333",e),e;this.errorChain.forEach(function(t){t.func&&"function"==typeof t.func&&(o.sdk.options.debug&&console.log("Propagating error",e),t.func(t.context,e))})}};var u=function(t){function e(e){t.call(this,e),this.currentDatabase=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getAll=function(){var t=this,e={method:"GET"};return this.__call("/__/index",e).then(function(e){return t.__checkError(t,e),e.result.objects})},e.prototype.select=function(t){return this.currentDatabase=t,this},e.prototype.add=function(t){var e=this;t=t||{};var o={method:"POST",data:t};return this.__callDatabase(o).then(function(t){return e.__checkError(e,t),t.result?t.result:t})},e.prototype.get=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o).then(function(t){return e.__checkError(e,t),t.result?t.result:[]})},e.prototype.getOne=function(t){var e=this;t=t||{},t._limit=1;var o={method:"GET",params:t};return this.__callDatabase(o).then(function(t){return e.__checkError(e,t),!(!t.result||!t.result[0])&&t.result[0]})},e.prototype.getCount=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/count").then(function(t){return e.__checkError(e,t),t.result?parseInt(t.result):0})},e.prototype.update=function(t,e){var o=this;e=e||{};var n={method:"PUT",data:e};return this.__callDatabase(n,"/"+t).then(function(t){return o.__checkError(o,t),t.result?t.result:t})},e.prototype.delete=function(t){var e=this,o={method:"DELETE"};return this.__callDatabase(o,"/"+t).then(function(t){return e.__checkError(e,t),t.result?t.result:t})},e.prototype.fieldExists=function(t){},e.prototype.addField=function(t){},e.prototype.getFields=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/structure/fields").then(function(t){return e.__checkError(e,t),t.result?t.result:[]})},e.prototype.getFilters=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/structure/filters").then(function(t){return e.__checkError(e,t),t.result?t.result:[]})},e.prototype.getViews=function(t){var e=this;t=t||{};var o={method:"GET",params:t};return this.__callDatabase(o,"/structure/views").then(function(t){return e.__checkError(e,t),t.result?t.result:[]})},e.prototype.getDistinct=function(t,e){},e.prototype.getDistinctCount=function(t,e){},e.prototype.__callDatabase=function(t,e){return e=e||"",null===this.currentDatabase?Promise.reject(new Error("Please select a database")):this.__call("/"+this.currentDatabase+e,t)},e}(c),l=function(e){function o(t){e.call(this,t)}return e&&(o.__proto__=e),o.prototype=Object.create(e&&e.prototype),o.prototype.constructor=o,o.prototype.getAll=function(){var t={method:"GET"};return this.__call("/__/function",t).then(function(t){return t.result})},o.prototype.run=function(t,e){e=e||!1;var o={method:"POST",data:e};return this.__call("/__/function/"+t,o).then(function(t){return t.result?t.result:t})},o.prototype.getFunctionIdUrl=function(e){return t(this.sdk.options)+"/__/function/"+e+"?token="+this.__getTokenToUse()},o}(c),p=function(e){function o(t){e.call(this,t)}return e&&(o.__proto__=e),o.prototype=Object.create(e&&e.prototype),o.prototype.constructor=o,o.prototype.getAll=function(){var t={method:"GET"};return this.__call("/__/storage",t).then(function(t){return t.result})},o.prototype.getUploadUrl=function(){return t(this.sdk.options)+"/__/storage?token="+this.__getTokenToUse()},o}(c),g=function(t){function e(e){t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){var t=this,e={method:"GET"};return this.__call("/__/remote-config",e).then(function(e){if("object"==typeof e){var o=t.options.defaultConfig;return Object.keys(e).forEach(function(t){o[t]=e[t]}),o}return t.options.defaultConfig})},e.prototype.defaultConfig=function(t){this.options.defaultConfig=t},e}(c),d=function(t){var r=this,i=this,a=Object.assign({},n,t);if(a.debug&&console.log("%cPreviolet Javascript SDK instantiated in debug mode","color: #CC00FF"),a.instance&&"<%= previolet.options.instance %>"==a.instance&&a.fallback&&a.fallback.instance&&(a.debug&&console.log("Using fallback instance",a.fallback.instance),a.instance=a.fallback.instance),a.tokenFallback&&a.tokenOverride)throw"Cannot define both tokenFallback and tokenOverride";a.tokenFallback&&"<%= previolet.token.guest %>"==a.tokenFallback&&(a.fallback&&a.fallback.tokenFallback?(a.debug&&console.log("Using fallback tokenFallback",a.fallback.tokenFallback),a.tokenFallback=a.fallback.tokenFallback):(a.debug&&console.log("No fallback tokenFallback provided, defaulting to false"),a.tokenFallback=!1)),a.tokenOverride&&"<%= previolet.token.guest %>"==a.tokenOverride&&(a.fallback&&a.fallback.tokenOverride?(a.debug&&console.log("Using fallback tokenOverride",a.fallback.tokenOverride),a.tokenOverride=a.fallback.tokenOverride):(a.debug&&console.log("No fallback tokenOverride provided, defaulting to false"),a.tokenOverride=!1));var s=!1,c=null,d=null,h={};this.changeHooks=[],this.storageApi=o(a),this.auth=function(){return{GithubAuthProvider:{id:"github"},GoogleAuthProvider:{id:"google"},FacebookAuthProvider:{id:"facebook"},logout:function(t){if(!i.auth().isAuthenticated())return Promise.reject(new Error("There is no authenticated user"));t=t||{},t.preventUserStatePropagation=t.preventUserStatePropagation||!1;var e=JSON.stringify({token:i.token}),o={method:"DELETE",data:e};return i.options.debug&&console.log("Logging Out"),i.token=!1,i.storageApi.removeItem(i.options.tokenName),i.storageApi.removeItem(i.options.applicationStorage),i.storageApi.removeItem(i.options.userStorage),t.preventUserStatePropagation||i.__propagateUserState(!1),i.__call("/__/token",o,"token").then(function(t){return t})},loginWithUsernameAndPassword:function(t,e){if(!t)return Promise.reject(new Error("username required"));if(!e)return Promise.reject(new Error("password required"));i.options.debug&&console.log("Logging In with username and password",t,e);var o=JSON.stringify({name:t,challenge:e,expire:i.options.userTokenExpiration}),n={method:"POST",data:o};return i.__call("/__/auth",n).then(function(t){return i.__checkError(i,t),i.__loadAuthenticationDataFromResponse(t),null!==i.currentUser&&i.__propagateUserState(i.currentUser),t.result.data})},loginWithIdentityProvider:function(t,e){e=e||r.last_access_token,r.last_access_token=e,r.options.debug&&console.log("Logging In with identity provider:",t,e);var o={access_token:e},n={method:"POST",params:o};return r.__call("/__/auth/identity/"+t,n).then(function(t){return r.__checkError(i,t),t.result?t.result&&(t.result.token&&t.result.auth?(i.__loadAuthenticationDataFromResponse(t),i.__propagateUserState(t.result.auth)):i.__propagateUserState(!1)):i.__propagateUserState(!1),t.result})},forgotPassword:function(t,e){if(!t)return Promise.reject(new Error("username required"));var o=e&&e.origin?e.origin:window.location.origin,n=!(!e||!e.skip_email)&&e.skip_email,r=JSON.stringify({name:t,origin:o,skip_email:n}),a={method:"POST",data:r};return i.__call("/__/auth/reset",a).then(function(t){return i.__checkError(i,t),t.result})},forgotPasswordConfirmation:function(t,e,o){if(!t)return Promise.reject(new Error("challenge required"));if(!e)return Promise.reject(new Error("confirm_challenge required"));if(!o)return Promise.reject(new Error("hash required"));var n=JSON.stringify({challenge:t,confirm_challenge:e,hash:o}),r={method:"POST",data:n};return i.__call("/__/auth/reset/confirm",r).then(function(t){return i.__checkError(i,t),t.result})},registerWithIdentityProvider:function(t,e,o,n){o=o||r.last_access_token,n=n||!0,r.last_access_token=o;var a={access_token:o,email:e,role:"admin"},s={method:"POST",data:a};return r.__call("/__/auth/identity/"+t+"/register",s).then(function(e){return r.__checkError(i,e),n?r.loginWithIdentityProvider(t,o):e})},isAuthenticated:function(){return!!i.token},loginAsGuest:function(){var t=JSON.stringify({expire:i.options.guestTokenExpiration}),e={method:"POST",data:t};return i.__call("/__/auth/guest",e).then(function(t){return t.error_code?void i.auth().logout():(i.__loadAuthenticationDataFromResponse(t),null!==i.currentUser&&i.__propagateUserState(i.currentUser),t.result.data)})},onAuthStateChanged:function(t){if("function"==typeof t){-1==i.changeHooks.indexOf(t)?(i.options.debug&&console.log("Registered callback function: onAuthStateChanged",t),i.changeHooks.push(t)):i.options.debug&&console.log("Callback function onAuthStateChanged is already registered",t);var e=i.currentUser,o=i.token;return i.options.debug&&(e&&o?console.log("User is logged in",e):console.log("User is not logged in")),t(o&&e?e:!1)}return i.options.debug&&console.log("User is not logged in"),!1}}},Object.defineProperties(this,{options:{get:function(){return a}},token:{get:function(){return s},set:function(t){t!=s&&(s=t,i.storageApi.setItem(a.tokenName,s))}},headers:{get:function(){return h}},currentApp:{get:function(){return c},set:function(t){c=t,i.storageApi.setItem(a.applicationStorage,btoa(JSON.stringify(t)))}},currentUser:{get:function(){return d},set:function(t){d=t,i.storageApi.setItem(a.userStorage,btoa(JSON.stringify(t)))}},browserIdentification:{get:function(){return i.__storageGet(i.options.browserIdentification)},set:function(t){t.ts=t.ts||Date.now(),t.rnd=t.rnd||e(1e4,99999),i.storageApi.setItem(a.browserIdentification,btoa(JSON.stringify(t)))}}}),i.app=function(){return{region:i.options.region,token:i.storageApi.getItem(i.options.tokenName)||!1,data:i.__storageGet(i.options.applicationStorage)}};var f=i.app().token;if(i.token=f,i.browserIdentification){i.options.debug&&console.log("Browser identification exists",i.browserIdentification);var _={ua:navigator.userAgent,lang:navigator.language||navigator.userLanguage,plat:navigator.platform,vsdk:i.options.sdkVersion,vapp:i.options.appVersion,ts:i.browserIdentification.ts,rnd:i.browserIdentification.rnd};JSON.stringify(_)!=JSON.stringify(i.browserIdentification)&&(i.options.debug&&console.log("Browser identification changed, renewing",_),i.browserIdentification=_)}else i.browserIdentification={ua:navigator.userAgent,lang:navigator.language||navigator.userLanguage,plat:navigator.platform,vsdk:i.options.sdkVersion,vapp:i.options.appVersion},i.options.debug&&console.log("Generating browser identification",i.browserIdentification);var k=new u(i).addToErrorChain(i,i.__checkError);i.db=function(){return k};var b=new l(i).addToErrorChain(i,i.__checkError);i.functions=function(){return b};var v=new p(i).addToErrorChain(i,i.__checkError);i.storage=function(){return v};var m=new g(i).addToErrorChain(i,i.__checkError);i.remoteConfig=function(){return m},i.user=function(){return{data:i.__storageGet(i.options.userStorage)}},i.currentUser=i.user().data};return d.prototype.getDefaultHeaders=function(){return Object.assign({},this.headers,{})},d.prototype.getRemoteConfig=function(){var t=this;return this.functions().getRemoteConfig().then(function(e){if("object"==typeof e){var o=t.options.defaultConfig;return Object.keys(e).forEach(function(t){o[t]=e[t]}),o}return t.options.defaultConfig})},d.prototype.__propagateUserState=function(t){var e=this;e.changeHooks.forEach(function(o){e.options.debug&&console.log("Triggering onAuthStateChanged callback",t),o(t)})},d.prototype.__loadAuthenticationDataFromResponse=function(t){t.result.token&&(this.options.debug&&console.log("Saving token",t.result.token),this.token=t.result.token),t.result.auth?(this.options.debug&&console.log("Saving user details",t.result.auth),this.currentUser=t.result.auth):(this.options.debug&&console.log("Saving default guest details"),this.currentUser={name:"Guest",username:"guest",guest:!0}),t.result.data&&(t.result.data[this.options.instance]&&t.result.data[this.options.instance].instance_data?(this.currentApp=t.result.data[this.options.instance].instance_data,this.options.debug&&console.log("Saving application details",this.currentApp)):this.options.debug&&console.log("Application details not available"))},d.prototype.__call=function(e,o,n){var r=this;n=n||this.options.instance,o.headers=this.getDefaultHeaders();var i=this.options.reqIndex++,a=t(this.options,n)+e;return this.options.debug&&console.log("> XHR Request ("+i+")",a,o),axios(a,o).then(function(t){return r.options.debug&&console.log("< XHR Response ("+i+")",t),t.data}).catch(function(t){throw t})},d.prototype.__storageGet=function(t){var e=this,o=e.storageApi.getItem(t),n=!1;if(o)try{n=JSON.parse(atob(o))}catch(t){}return n},d.prototype.__checkError=function(t,e){if(e.error)throw t.options.debug&&console.log("%cBackend error details","color: #FF3333",e),!e.error_code||e.error_code!=r.INVALID_TOKEN&&e.error_code!=r.TOKEN_DOESNT_MATCH_INSTANCE||(t.user().data.guest?t.auth().loginAsGuest():t.auth().logout()),e},d});